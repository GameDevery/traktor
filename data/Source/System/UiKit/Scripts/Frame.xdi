<?xml version="1.0" encoding="utf-8"?>
<object type="traktor.script.Script" version="2">
	<text>
	<![CDATA[
#using \{7947759C-88DB-794E-8D09-7F30A40B6669}
#using \{26FCC8EA-F349-5545-93B5-6ABDAE065E6F}

-- Frame

Frame = Frame or class("Frame", Container)

function Frame:new(root_mc, vwidth, vheight, layout)
	local depth = root_mc:getNextHighestDepth()
	local mc = root_mc:createEmptyMovieClip("mc", depth)
	self:_initialize(mc, vwidth, vheight, layout)
end

function Frame:remove()
	self._mc:setMember("onEnterFrame", nil)
	self._mc:setMember("onMouseDown", nil)
	self._mc:setMember("onMouseUp", nil)
	self._mc:setMember("onMouseMove", nil)
	Widget.remove(self)
end

function Frame:getPreferredSize()
	return { width = 0, height = 0 }
end

function Frame:update()
	local cx = self._mc:getContext()
	local stage = cx:getGlobal():getMember("Stage")

	local width = stage:getProperty("width")
	local height = stage:getProperty("height")
	assert (width > 0)
	assert (height > 0)

	local xscale = width / self._vwidth
	local yscale = height / self._vheight
	local scale = math.min(xscale, yscale)

	self._mc:setXScale(scale * 100)
	self._mc:setYScale(scale * 100)

	self:place(0, 0, width / scale, height / scale)
end

-- Private

function Frame:_initialize(mc, vwidth, vheight, layout)
	Container._initialize(self, nil, mc, layout)

	-- Disable stage scale and position, register listener of changes in stage size.
	local cx = mc:getContext()
	local stage = cx:getGlobal():getMember("Stage")
	local listener = cx:createObject()
	listener:setMember("onResize", function() self:update() end)
	stage:addListener(listener)
	stage:setProperty("scaleMode", "noScale")
	stage:setProperty("align", "TL")

	self._vwidth = vwidth
	self._vheight = vheight

	-- Setup event source listeners.
	self._mc:setMember("onEnterFrame", function() self:_eventEnterFrame() end)
	self._mc:setMember("onMouseDown", function() self:_eventMouseDown() end)
	self._mc:setMember("onMouseUp", function() self:_eventMouseUp() end)
	self._mc:setMember("onMouseMove", function() self:_eventMouseMove() end)

	local mouse = cx:getGlobal():getMember("Mouse")
	local listener = cx:createObject()
	listener:setMember("onMouseWheel", function(delta) self:_eventMouseWheel(delta) end)
	mouse:addListener(listener)

#if defined(_DEBUG)
	self._mc_debug = Widget._createResource(self, "MC_DebugMarker")
	self._tb_position = self._mc_debug:getMember("tb_position")
#endif
end

function Frame:_eventEnterFrame()
	self:_dispatchEvent(FrameEvent())
end

function Frame:_eventMouseDown()
	local pt = self:getMousePosition()
	self:_dispatchEvent(MouseDownEvent(pt.x, pt.y))
end

function Frame:_eventMouseUp()
	local pt = self:getMousePosition()
	self:_dispatchEvent(MouseUpEvent(pt.x, pt.y))
end

function Frame:_eventMouseMove()
	local pt = self:getMousePosition()
#if defined(_DEBUG)
	self._mc_debug:setPosition(Vector2(pt.x, pt.y))
	self._tb_position:parseText(pt.x .. ";" .. pt.y)
#endif
	self:_dispatchEvent(MouseMoveEvent(pt.x, pt.y))
end

function Frame:_eventMouseWheel(delta)
	local pt = self:getMousePosition()
	self:_dispatchEvent(MouseWheelEvent(pt.x, pt.y, delta))
end

	]]>
	</text>
</object>
