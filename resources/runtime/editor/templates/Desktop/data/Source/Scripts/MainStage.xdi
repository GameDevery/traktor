<?xml version="1.0" encoding="utf-8"?>
<object type="traktor.script.Script" version="2">
	<text>
	<![CDATA[
#using \{FC4400A2-BDB6-BA45-9A22-12B9676E71FA}

-- MainStage

MainStage = MainStage or inherit(traktor.amalgam.Stage)
MainStage_meta = MainStage_meta or { __index = MainStage }

function MainStage.new(o, params, environment)
	o = o or {}
	setmetatable(o, MainStage_meta)

	-- Save input mapping in member for quick access.
	o.inputMapping = environment:getInput():getInputMapping()

	-- Access entities and save inital transform of camera.
	local cubeEntity = o.world:getEntity("Cube")
	local cameraEntity = o.world:getEntity("Camera")
	local cameraTransform = cameraEntity:getTransform()

	-- Initialize UiKit.
	Widget.initialize(
		environment,
		{ "\{5ABEAE05-EB26-934F-932F-7F3C7C582383}" }
	)

	-- Create UI frame with virtual size of 1280x720.
	local root = o.ui:getRoot()
	o._frame = Frame.new(
		root,
		1280, 720,
		TableLayout.new({ 0 }, { 0 }, 4, 4, 4, 4)
	)

	-- Create static label.
	o._lbl = Static.new(o._frame, "Time: 0")

	-- Create reset button.
	o._btn = PushButton.new(o._frame, "Reset")
	o._btn:setOnClick(function()
		cubeEntity:reset()
		cameraEntity:setTransform(cameraTransform)
	end)

	-- Ensure layout is updated.
	o._frame:update()
	return o
end

function MainStage:finalize()
	self._frame:remove()
	self._frame = nil
end

function MainStage:update(info)
	local dT = info:getSimulationDeltaTime()

	-- Update input.
	local moveX = self.inputMapping:getStateValue("STATE_MOVE_X")
	local moveZ = self.inputMapping:getStateValue("STATE_MOVE_Z")

	local cameraEntity = self.world:getEntity("Camera")
	local cameraTransform = cameraEntity:getTransform()
	cameraTransform = cameraTransform * Transform(Vector4(moveX * 2 * dT, 0, moveZ * 2 * dT), Quaternion.identity)
	cameraEntity:setTransform(cameraTransform)

	-- Update UI.
	self._lbl:setText("Time: " .. info:getSimulationTime())
end

	]]>
	</text>
</object>
